<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
        integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
        crossorigin=""></script>
    <script src="https://cdn.osmbuildings.org/classic/0.2.2b/OSMBuildings-Leaflet.js"></script>
    <script type="text/javascript" src="Dependencies/Census_Visualization/grpc_querier.bundle.js"></script>
    <script type="text/javascript" src="Dependencies/Census_Visualization/census_visualizer.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="Dependencies/leaflet-sidebar.js"></script>
    <script src="Dependencies/getInfrastructure.js"></script>
    <link rel="stylesheet" type="text/css" href="Dependencies/MarkerCluster.css">
    <link rel="stylesheet" type="text/css" href="Dependencies/MarkerCluster.Default.css">
    <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
    <script src="Dependencies/simplify.js"></script>
    <script src="Dependencies/leaflet.markercluster.js"></script>
    <script src="Dependencies/selectGenerator.js"></script>
    <link rel="stylesheet" type="text/css" href="Dependencies/leaflet-sidebar.css">
    <link rel="stylesheet" type="text/css" href="IframeStyle.css">
</head>
<body>
    <!--Required for this map to be controlled-->
    <script>const MAPNUMBER = 3; //refers to whatever map in the grid this refers to</script>
    <script src="Dependencies/mouseDown.js"></script>
    <script>thisMapNumber=MAPNUMBER; //changes a variable in the mouseDown.js script</script>
    <!------------------------------------------>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li>
                    <a href="#home" role="tab">
                        <img style="width:35px;height:35px;" src="../../images/hamburger-button.svg">
                    </a>
                </li>
            </ul>

        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    Demographic & Risk Data
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div class="selectContainer" id="checkboxLocation">
                </div>
            </div>
        </div>
    </div>
    <div id="map" class="sidebar-map"></div>

    <div id='map3' class='map'>
    </div>
    <script>
        var buildingmap = new L.Map('map3');
        buildingmap.setView(buildingmap.wrapLatLng(parent.view), 10, false);
        console.log(buildingmap.getCenter())

        var sidebar = L.control.sidebar('sidebar', {
            position: 'right'
        }).addTo(buildingmap);

        new L.TileLayer('https://api.mapbox.com/styles/v1/osmbuildings/cjt9gq35s09051fo7urho3m0f/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1Ijoib3NtYnVpbGRpbmdzIiwiYSI6IjNldU0tNDAifQ.c5EU_3V8b87xO24tuWil0w', {
          attribution: 'Â© Map tiles <a href="https://mapbox.com">Mapbox</a>',
          maxZoom: 18,
          maxNativeZoom: 20
        }).addTo(buildingmap);

        var osmb = new OSMBuildings(buildingmap).load('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json');

        const censusViz = census_visualizer();
        censusViz.updateViz(buildingmap);

        var markers = L.markerClusterGroup({
            showCoverageOnHover: false,
            spiderfyOnMaxZoom: false,
            disableClusteringAtZoom: 17,
            maxClusterRadius: 55
        });
        buildingmap.addLayer(markers);

        $.getJSON("Dependencies/demographicsAndRisk.json", function (data) {
          RenderInfrastructure.config(buildingmap, markers, data, {
              queryAlertText: document.getElementById('queryInfoText'),
              overpassInterpreter: 'http://lattice-136.cs.colostate.edu:4096/api/interpreter',
              maxElements: 10000,
              maxLayers:20,
              simplifyThreshold: 0.00005
          });
          Generator.config(data, document.getElementById("checkboxLocation"), true, changeChecked, "checkbox", true);
          runQuery();
        });

        const g = {groupMem: "Census", query: 1};
        const census = {"Total Population": g, "Avg. Household Income": g,
          "Population by Age": g, "Median Age": g, "No. Below Poverty Line": g, "Demographics": g}

        function changeChecked(element) {
            if (element.checked) {
                if(element.id in census){
                  censusViz.setFeature(element.id);
                  censusViz.updateViz(buildingmap);
                } else {
                  RenderInfrastructure.addFeatureToMap(element.id);
                }
            }
            else {
                if(element.id in census)
                  censusViz.setFeature(element.id);
                else
                  RenderInfrastructure.removeFeatureFromMap(element.id);
            }
        }

        function runQuery() {
            RenderInfrastructure.update();
        }


        Generator.config(census, document.getElementById("checkboxLocation"), true, changeChecked, "radio", true);

        //updates controller----------------------------------------------
        buildingmap.on("move", function () {
            parent.setGlobalPosition(buildingmap.getCenter(),MAPNUMBER);
        });
        buildingmap.on("zoomend", function () {
            parent.setGlobalPositionFORCE(buildingmap.getCenter(),MAPNUMBER);
        });
        buildingmap.on("moveend", function () {
            censusViz.updateViz(buildingmap);
        });
        //----------------------------------------------------------------
    </script>

    <!--You must add this map's setter function-->
    <script>
    var thisMapsSetter = function(view,zoom){
        buildingmap.setView(buildingmap.wrapLatLng(view), buildingmap.getZoom());
        censusViz.updateViz(buildingmap);
    }
        parent.setterFunctions.push({
            setterFunc: thisMapsSetter,
            mapNum: MAPNUMBER
        });
    </script>
</body>
