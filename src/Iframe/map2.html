<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
    <link rel="stylesheet" type="text/css" href="IframeStyle.css">
    <script src="Dependencies/leaflet-sidebar.js"></script>
    <link rel="stylesheet" type="text/css" href="Dependencies/leaflet-sidebar.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
    <script src="Dependencies/simplify.js"></script>
    <script src="Dependencies/Other_Datasets/grpc_querier.bundle.js"></script>
    <link rel="stylesheet" type="text/css" href="Dependencies/MarkerCluster.css">
    <link rel="stylesheet" type="text/css" href="Dependencies/MarkerCluster.Default.css">
    <script src="Dependencies/leaflet.markercluster.js"></script>
    <script src="Dependencies/selectGenerator.js"></script>
</head>

<body>
    <!--Required for this map to be controlled-->
    <script>const MAPNUMBER = 2; //refers to whatever map in the grid this refers to</script>
    <script src="Dependencies/mouseDown.js"></script>
    <script>thisMapNumber = MAPNUMBER; //changes a variable in the mouseDown.js script</script>
    <!------------------------------------------>
    <div class="leaflet-bottom leaflet-left">
        <div class='queryInfo'>
            <div id='queryInfoText'>

            </div>
        </div>
    </div>
    <script>
        let queryAlertText = document.getElementById('queryInfoText');
    </script>
    <script src="Dependencies/getInfrastructure.js"></script>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li>
                    <a href="#home" role="tab">
                        <img style="width:35px;height:35px;" src="../../images/hamburger-button.svg">
                    </a>
                </li>
            </ul>

        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h6 class="sidebar-header">
                    Infrastructure & Natural Features
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h6>
                <div class="selectContainer" id="checkboxLocation">
                </div>
            </div>
        </div>
    </div>
    <div id="map" class="sidebar-map"></div>

    <!------------------------------------------>
    <div id='map2' class='map'></div>
    <script>
        osmMap2 = L.map('map2', {
            renderer: L.canvas(),
            minZoom: 3,
            fullscreenControl: true,
            inertia: false,
            timeDimension: false,
            minZoom: 11
        });

        osmMap2.setView(osmMap2.wrapLatLng(parent.view), 11);
        var tiles2 = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 18
        }).addTo(osmMap2);


        var sidebar = L.control.sidebar('sidebar', {
            position: 'right'
        }).addTo(map);

        var markers = L.markerClusterGroup({
            showCoverageOnHover: false,
            spiderfyOnMaxZoom: false,
            disableClusteringAtZoom: 17,
            maxClusterRadius: 55
        });
        osmMap2.addLayer(markers);

        $.getJSON("Dependencies/streamflowMetadata.json", function (mdata) {
            RenderInfrastructure.preProcessData = mdata;
            $.getJSON("Dependencies/waterInfrastructure.json", function (data) {
                RenderInfrastructure.config(osmMap2, markers, data, {
                    queryAlertText: document.getElementById('queryInfoText'),
                    overpassInterpreter: 'http://lattice-136.cs.colostate.edu:4096/api/interpreter',
                    maxElements: 10000,
                    maxLayers:20,
                    simplifyThreshold: 0.00005
                });
                Generator.config(data, document.getElementById("checkboxLocation"), true, changeChecked, "checkbox", true,
                '<ul style="padding-inline-start:20px;">' +
                    '<li><b>Reservoir/Lake/Basin/Pond</b>: Icon made from <a href="http://www.onlinewebfonts.com/icon">Icon Fonts</a> is licensed by CC BY 3.0</li>' +
                    '<li><b>Wastewater Plant</b>: Icons made by <a href="https://www.flaticon.com/authors/smashicons" title="Smashicons">Smashicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></li>' +
                    '<li><b>Dam</b>: Icon from <a href="http://www.iconsmind.com">iconsmind.com</a></li>' +
                    '<li><b>Hospital</b>: Icons from Font Awesome by Dave Gandy - <a href="https://fortawesome.github.com/Font-Awesome">fortawesome.github.com/Font-Awesome</a> / CC BY-SA (<a href="https://creativecommons.org/licenses/by-sa/3.0">creativecommons.org/licenses/by-sa/3.0</a>)</li>' +
                    '<li><b>Urgent Care</b>: Icon By Bridget Gahagan, <a href="https://thenounproject.com/">noun project</a></li>' + 
                    '<li><b>Fire Station</b>: Icon From <a href="https://icons8.com/">icons8.com</a></li>' +
                '</ul>'
                );
                runQuery();
            });
        });

        //selectedObjects.forEach(object => osmMap2.addLayer(object));


        function updateOverPassLayer() {
            RenderInfrastructure.update();
        }

        function removeOverpassLayer(map, removeLayer) {
            map.eachLayer(function (layer) {
                //console.log(layer.options);
                if (layer.options.id === "OverPassLayer" && layer.options.query == removeLayer.options.query) {
                    map.removeLayer(layer);
                }
            });
        }

        function changeChecked(element) {
            if (element.checked) {
                RenderInfrastructure.addFeatureToMap(element.id);
            }
            else {
                RenderInfrastructure.removeFeatureFromMap(element.id);
            }
        }

        parent.addEventListener('updateMaps', function () {
            runQuery();
        });

        function runQuery() {
            updateOverPassLayer();
        }

        osmMap2.on("move", function (e) {
            parent.setGlobalPosition(osmMap2.getCenter(), MAPNUMBER);
        });
        osmMap2.on("zoomend", function () {
            parent.setGlobalPositionFORCE(osmMap2.getCenter(), MAPNUMBER);
        });
    </script>


    <!--You must add this map's setter function-->
    <script>
        var thisMapsSetter = function (view, zoom) {
            osmMap2.setView(osmMap2.wrapLatLng(parent.view), osmMap2.getZoom());
        }
        parent.setterFunctions.push({
            setterFunc: thisMapsSetter,
            mapNum: MAPNUMBER
        });
        setTimeout(function () {
            osmMap2.setView([osmMap2.wrapLatLng(parent.view).lat, osmMap2.wrapLatLng(parent.view).lng - 0.0002], osmMap2.getZoom());
        }, 1); //this is a terrible fix but it works for now
    </script>
</body>
